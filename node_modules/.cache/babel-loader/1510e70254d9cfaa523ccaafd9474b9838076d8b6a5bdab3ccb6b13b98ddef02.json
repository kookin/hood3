{"ast":null,"code":"import { EventEmitter } from \"events\";\nimport { safeJsonParse, safeJsonStringify } from \"@walletconnect/safe-json\";\nimport { formatJsonRpcError, isReactNative, isWsUrl, isLocalhostUrl, parseConnectionError } from \"@walletconnect/jsonrpc-utils\";\nconst EVENT_EMITTER_MAX_LISTENERS_DEFAULT = 10;\nconst resolveWebSocketImplementation = () => {\n  if (typeof global !== \"undefined\" && typeof global.WebSocket !== \"undefined\") {\n    return global.WebSocket;\n  }\n  if (typeof window !== \"undefined\" && typeof window.WebSocket !== \"undefined\") {\n    return window.WebSocket;\n  }\n  return require(\"ws\");\n};\nconst isBrowser = () => typeof window !== \"undefined\";\nconst WS = resolveWebSocketImplementation();\nexport class WsConnection {\n  constructor(url) {\n    this.url = url;\n    this.events = new EventEmitter();\n    this.registering = false;\n    if (!isWsUrl(url)) {\n      throw new Error(`Provided URL is not compatible with WebSocket connection: ${url}`);\n    }\n    this.url = url;\n  }\n  get connected() {\n    return typeof this.socket !== \"undefined\";\n  }\n  get connecting() {\n    return this.registering;\n  }\n  on(event, listener) {\n    this.events.on(event, listener);\n  }\n  once(event, listener) {\n    this.events.once(event, listener);\n  }\n  off(event, listener) {\n    this.events.off(event, listener);\n  }\n  removeListener(event, listener) {\n    this.events.removeListener(event, listener);\n  }\n  async open() {\n    let url = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.url;\n    await this.register(url);\n  }\n  async close() {\n    return new Promise((resolve, reject) => {\n      if (typeof this.socket === \"undefined\") {\n        reject(new Error(\"Connection already closed\"));\n        return;\n      }\n      this.socket.onclose = event => {\n        this.onClose(event);\n        resolve();\n      };\n      this.socket.close();\n    });\n  }\n  async send(payload, context) {\n    if (typeof this.socket === \"undefined\") {\n      this.socket = await this.register();\n    }\n    try {\n      this.socket.send(safeJsonStringify(payload));\n    } catch (e) {\n      this.onError(payload.id, e);\n    }\n  }\n  register() {\n    let url = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.url;\n    if (!isWsUrl(url)) {\n      throw new Error(`Provided URL is not compatible with WebSocket connection: ${url}`);\n    }\n    if (this.registering) {\n      const currentMaxListeners = this.events.getMaxListeners();\n      if (this.events.listenerCount(\"register_error\") >= currentMaxListeners || this.events.listenerCount(\"open\") >= currentMaxListeners) {\n        this.events.setMaxListeners(currentMaxListeners + 1);\n      }\n      return new Promise((resolve, reject) => {\n        this.events.once(\"register_error\", error => {\n          this.resetMaxListeners();\n          reject(error);\n        });\n        this.events.once(\"open\", () => {\n          this.resetMaxListeners();\n          if (typeof this.socket === \"undefined\") {\n            return reject(new Error(\"WebSocket connection is missing or invalid\"));\n          }\n          resolve(this.socket);\n        });\n      });\n    }\n    this.url = url;\n    this.registering = true;\n    return new Promise((resolve, reject) => {\n      const opts = !isReactNative() ? {\n        rejectUnauthorized: !isLocalhostUrl(url)\n      } : undefined;\n      const socket = new WS(url, [], opts);\n      if (isBrowser()) {\n        socket.onerror = event => {\n          const errorEvent = event;\n          reject(this.emitError(errorEvent.error));\n        };\n      } else {\n        socket.on(\"error\", errorEvent => {\n          reject(this.emitError(errorEvent));\n        });\n      }\n      socket.onopen = () => {\n        this.onOpen(socket);\n        resolve(socket);\n      };\n    });\n  }\n  onOpen(socket) {\n    socket.onmessage = event => this.onPayload(event);\n    socket.onclose = event => this.onClose(event);\n    this.socket = socket;\n    this.registering = false;\n    this.events.emit(\"open\");\n  }\n  onClose(event) {\n    this.socket = undefined;\n    this.registering = false;\n    this.events.emit(\"close\", event);\n  }\n  onPayload(e) {\n    if (typeof e.data === \"undefined\") return;\n    const payload = typeof e.data === \"string\" ? safeJsonParse(e.data) : e.data;\n    this.events.emit(\"payload\", payload);\n  }\n  onError(id, e) {\n    const error = this.parseError(e);\n    const message = error.message || error.toString();\n    const payload = formatJsonRpcError(id, message);\n    this.events.emit(\"payload\", payload);\n  }\n  parseError(e) {\n    let url = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.url;\n    return parseConnectionError(e, url, \"WS\");\n  }\n  resetMaxListeners() {\n    if (this.events.getMaxListeners() > EVENT_EMITTER_MAX_LISTENERS_DEFAULT) {\n      this.events.setMaxListeners(EVENT_EMITTER_MAX_LISTENERS_DEFAULT);\n    }\n  }\n  emitError(errorEvent) {\n    const error = this.parseError(new Error((errorEvent === null || errorEvent === void 0 ? void 0 : errorEvent.message) || `WebSocket connection failed for URL: ${this.url}`));\n    this.events.emit(\"register_error\", error);\n    return error;\n  }\n}\nexport default WsConnection;","map":{"version":3,"names":["EventEmitter","safeJsonParse","safeJsonStringify","formatJsonRpcError","isReactNative","isWsUrl","isLocalhostUrl","parseConnectionError","EVENT_EMITTER_MAX_LISTENERS_DEFAULT","resolveWebSocketImplementation","global","WebSocket","window","require","isBrowser","WS","WsConnection","constructor","url","events","registering","Error","connected","socket","connecting","on","event","listener","once","off","removeListener","open","arguments","length","undefined","register","close","Promise","resolve","reject","onclose","onClose","send","payload","context","e","onError","id","currentMaxListeners","getMaxListeners","listenerCount","setMaxListeners","error","resetMaxListeners","opts","rejectUnauthorized","onerror","errorEvent","emitError","onopen","onOpen","onmessage","onPayload","emit","data","parseError","message","toString"],"sources":["../../src/ws.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}